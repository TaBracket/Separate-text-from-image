<!DOCTYPE html><meta charset="utf-8" />
<style>
  body {
    font-family: system-ui;
    margin: 24px;
  }
  .row {
    display: flex;
    gap: 24px;
    align-items: flex-start;
    flex-wrap: wrap;
  }
  .col {
    min-width: 320px;
  }
  img {
    max-width: 560px;
    display: block;
  }
  label {
    display: block;
    margin-top: 8px;
    font-size: 12px;
    opacity: 0.8;
  }
  input[type="range"] {
    width: 240px;
  }
  pre {
    background: #0b0d10;
    color: #e6eef8;
    padding: 12px;
    border-radius: 8px;
    max-width: 560px;
    overflow: auto;
  }
  button {
    padding: 8px 12px;
    border-radius: 10px;
    border: 1px solid #ccc;
    cursor: pointer;
  }
</style>

<h2>High-Contrast Item Detector — Frontend Test</h2>
<div class="row">
  <div class="col">
    <input id="file" type="file" accept="image/*" />
    <label>target_width: <span id="v_w">960</span></label>
    <input id="w" type="range" min="400" max="1600" step="20" value="960" />
    <label>blur_kernel: <span id="v_b">5</span></label>
    <input id="b" type="range" min="1" max="31" step="2" value="5" />
    <label>canny_low: <span id="v_l">50</span></label>
    <input id="l" type="range" min="0" max="255" step="1" value="50" />
    <label>canny_high: <span id="v_h">150</span></label>
    <input id="h" type="range" min="0" max="255" step="1" value="150" />
    <label>approx_eps: <span id="v_e">2.0</span></label>
    <input id="e" type="range" min="0" max="20" step="0.5" value="2.0" />

    <div style="margin-top: 12px; display: flex; gap: 8px">
      <button id="go">Detect (JSON + Overlay)</button>
      <button id="dl">Download Overlay</button>
    </div>
  </div>

  <div class="col">
    <strong>Overlay</strong>
    <img id="overlay" alt="" />
  </div>

  <div class="col">
    <strong>JSON</strong>
    <pre id="json">{}</pre>
  </div>
</div>

<script>
  const API = "http://127.0.0.1:8000"; // اگر لازم شد تغییر بده

  const $ = (id) => document.getElementById(id);
  const f = $("file"),
    go = $("go"),
    dl = $("dl"),
    ov = $("overlay"),
    js = $("json");
  const w = $("w"),
    b = $("b"),
    l = $("l"),
    h = $("h"),
    e = $("e");
  const vw = $("v_w"),
    vb = $("v_b"),
    vl = $("v_l"),
    vh = $("v_h"),
    ve = $("v_e");

  [w, b, l, h, e].forEach((inp) => inp.addEventListener("input", syncVals));
  function syncVals() {
    vw.textContent = w.value;
    vb.textContent = b.value;
    vl.textContent = l.value;
    vh.textContent = h.value;
    ve.textContent = e.value;
  }
  syncVals();

  function buildQuery() {
    const p = new URLSearchParams({
      target_width: w.value,
      blur_kernel: b.value,
      canny_low: l.value,
      canny_high: h.value,
      approx_eps: e.value,
      // می‌تونی min_area_ratio / max_area_ratio / edge_penalty رو هم اضافه کنی
    });
    return p.toString();
  }

  async function callDetect(form) {
    const url = `${API}/detect?${buildQuery()}`;
    const res = await fetch(url, { method: "POST", body: form });
    if (!res.ok) throw new Error(await res.text());
    return res.json();
  }

  async function callOverlay(form) {
    const url = `${API}/detect/overlay?${buildQuery()}`;
    const res = await fetch(url, { method: "POST", body: form });
    if (!res.ok) throw new Error(await res.text());
    return res.blob();
  }

  go.onclick = async () => {
    if (!f.files[0]) return alert("Pick an image first.");
    const form = new FormData();
    form.append("file", f.files[0]);
    js.textContent = "Processing...";
    ov.removeAttribute("src");
    try {
      const [j, b] = await Promise.all([callDetect(form), callOverlay(form)]);
      js.textContent = JSON.stringify(j, null, 2);
      ov.src = URL.createObjectURL(b);
    } catch (err) {
      js.textContent = "Error: " + err.message;
    }
  };

  dl.onclick = async () => {
    if (!f.files[0]) return alert("Pick an image first.");
    const form = new FormData();
    form.append("file", f.files[0]);
    try {
      const b = await callOverlay(form);
      const a = document.createElement("a");
      a.href = URL.createObjectURL(b);
      a.download = "overlay.png";
      a.click();
    } catch (err) {
      alert("Download failed: " + err.message);
    }
  };
</script>
